import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import easyocr
import numpy as np
from PIL import Image

# --- CONFIG & MASTER DATA ---
st.set_page_config(page_title="RTE Management Dashboard", layout="wide")

TARGET_REVENUE = 170000.0

# ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
CATEGORY_MAP = {
    # ‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô
    "203081": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "250561": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "274583": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "299207": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô",
    "381059": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "395441": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "614329": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "619903": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô",
    "648962": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "779278": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "782617": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "956994": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô",
    # ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô
    "231259": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "302490": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "322224": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "344174": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô",
    "364882": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "380450": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "621822": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "654830": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô",
    "695884": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "724276": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "781110": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "951651": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô",
    "250271": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "273023": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "967970": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô"
}

PRODUCT_NAMES = {
    "203081": "‡∏Æ‡πá‡∏≠‡∏ó‡∏î‡πá‡∏≠‡∏Å", "250561": "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ö‡∏´‡∏°‡∏π ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "274583": "‡∏ä‡∏∏‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î",
    "299207": "‡πÑ‡∏Å‡πà‡∏õ‡πä‡∏≠‡∏õ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "381059": "‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡πÑ‡∏Å‡πà‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Ñ", "395441": "‡∏Æ‡∏∞‡πÄ‡∏Å‡πã‡∏≤‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "614329": "‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏´‡∏°‡∏π‡∏Å‡∏∏‡∏¢‡∏ä‡πà‡∏≤‡∏¢ ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "619903": "‡∏õ‡∏µ‡∏Å‡πÑ‡∏Å‡πà‡∏ö‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å‡∏ã‡∏≠‡∏™",
    "648962": "‡∏Æ‡∏∞‡πÄ‡∏Å‡πã‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô", "779278": "‡πÑ‡∏Å‡πà‡∏õ‡πä‡∏≠‡∏õ", "782617": "‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏´‡∏°‡∏π‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "956994": "‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "231259": "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏®", "302490": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á‡πÉ‡∏´‡∏ç‡πà", 
    "322224": "‡∏¢‡∏≥‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö", "344174": "‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏±‡∏ô", "364882": "‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á", 
    "380450": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà", "621822": "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô 99 ‡∏ö‡∏≤‡∏ó", 
    "654830": "‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏™‡πâ", "695884": "‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö ‡πÅ‡∏û‡πá‡∏Ñ‡πÉ‡∏´‡∏ç‡πà", 
    "724276": "‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡∏û‡∏∞‡πÇ‡∏•‡πâ (‡πÄ‡∏•‡∏≤‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠)", "781110": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ‡πÉ‡∏´‡∏ç‡πà", 
    "951651": "‡∏Å‡∏∏‡πâ‡∏á‡∏ï‡πâ‡∏°", "250271": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á", 
    "273023": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Æ‡πà‡∏≠‡∏á‡∏Å Hong Kong", "967970": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ"
}

@st.cache_resource
def get_reader():
    return easyocr.Reader(['th', 'en'])

reader = get_reader()

# --- SIDEBAR ---
st.sidebar.title("üìå ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å")
page = st.sidebar.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤", ["üè† ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", "üçü ‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "üç± ‡∏´‡∏°‡∏ß‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô"])
uploaded_file = st.sidebar.file_uploader("üì∑ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢", type=['jpg', 'png', 'jpeg'])

if uploaded_file:
    image = Image.open(uploaded_file)
    img_np = np.array(image)
    result = reader.readtext(img_np)
    full_text = [res[1] for res in result]
    
    raw_data = {}
    for i, text in enumerate(full_text):
        clean_code = text.replace(" ", "").strip()
        if clean_code in CATEGORY_MAP:
            try:
                # ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç Qty ‡πÅ‡∏•‡∏∞ Amount
                qty = float(full_text[i+2].replace(",", ""))
                amt_raw = float(full_text[i+3].replace(",", ""))
                raw_data[clean_code] = {"qty": qty, "amt": amt_raw}
            except: continue

    # 3.2 & 3.3 ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏¢‡∏≠‡∏î ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô 99 ‡∏ö‡∏≤‡∏ó (621822)
    if "621822" in raw_data:
        item99 = raw_data.pop("621822")
        allocation = {"231259": 0.5, "654830": 0.3, "724276": 0.2}
        for code, ratio in allocation.items():
            if code not in raw_data: raw_data[code] = {"qty": 0, "amt": 0}
            raw_data[code]["qty"] += item99["qty"] * ratio
            raw_data[code]["amt"] += item99["amt"] * ratio

    # ‡∏™‡∏£‡πâ‡∏≤‡∏á DataFrame ‡∏´‡∏•‡∏±‡∏Å
    final_data = []
    for c, v in raw_data.items():
        final_data.append({
            "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà": CATEGORY_MAP[c],
            "‡∏£‡∏´‡∏±‡∏™": c,
            "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": PRODUCT_NAMES[c],
            "Qty Sum": v["qty"],
            "Amount (‡∏Å‡πà‡∏≠‡∏ô VAT)": v["amt"],
            "Amount (+VAT 7%)": round(v["amt"] * 1.07, 2)
        })
    
    df = pd.DataFrame(final_data)

    if page == "üè† ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢":
        st.header("üè† ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢")
        
        total_vat = df["Amount (+VAT 7%)"].sum()
        achieve_pct = (total_vat / TARGET_REVENUE) * 100
        
        # Gauge Chart
        fig_gauge = go.Figure(go.Indicator(
            mode = "gauge+number+delta",
            value = total_vat,
            title = {'text': f"‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ {TARGET_REVENUE:,.0f} THB"},
            delta = {'reference': TARGET_REVENUE},
            gauge = {'axis': {'range': [None, TARGET_REVENUE]},
                     'bar': {'color': "#1f77b4"},
                     'steps': [{'range': [0, TARGET_REVENUE], 'color': "#e5ecf6"}]}))
        st.plotly_chart(fig_gauge)
        
        st.metric("Achievement", f"{achieve_pct:.2f}%", delta=f"{total_vat - TARGET_REVENUE:,.2f} THB")

        # 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏î‡∏ï‡∏Å (Qty ‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î)
        st.subheader("‚ö†Ô∏è 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ú‡∏•‡∏±‡∏Å‡∏î‡∏±‡∏ô (‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢)")
        low_3 = df.sort_values(by="Qty Sum").head(3)
        cols = st.columns(3)
        for i, row in enumerate(low_3.itertuples()):
            cols[i].warning(f"**{row.‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤}** \nQty: {row.Qty_Sum}  \n‡∏¢‡∏≠‡∏î: {row._6:,.2f}")

        # ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏ß‡∏°
        st.subheader("üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        fig_total = px.bar(df.sort_values("Qty Sum", ascending=False), 
                           x="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", y="Amount (+VAT 7%)", color="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", text_auto='.2s')
        st.plotly_chart(fig_total, use_container_width=True)

    else:
        # ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
        cat = "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô" if "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô" in page else "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô"
        st.header(f"üìç ‡∏´‡∏°‡∏ß‡∏î{cat}")
        sub_df = df[df["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"] == cat].sort_values("Qty Sum", ascending=False).reset_index(drop=True)
        
        if not sub_df.empty:
            # ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î 2 ‡πÅ‡∏ö‡∏ö
            c1, c2 = st.columns(2)
            c1.metric("‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô VAT", f"{sub_df['Amount (‡∏Å‡πà‡∏≠‡∏ô VAT)'].sum():,.2f}")
            c2.metric("‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (+VAT 7%)", f"{sub_df['Amount (+VAT 7%)'].sum():,.2f}")
            
            # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
            st.subheader(f"üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏´‡∏°‡∏ß‡∏î{cat}")
            def highlight_top3(row):
                if row.name < 3: return ['background-color: #ffd700; color: black; font-weight: bold'] * len(row)
                return [''] * len(row)
            
            st.table(sub_df.style.apply(highlight_top3, axis=1).format({"Amount (‡∏Å‡πà‡∏≠‡∏ô VAT)": "{:,.2f}", "Amount (+VAT 7%)": "{:,.2f}"}))
        else:
            st.warning("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ")

else:
    st.info("üëà ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô")
