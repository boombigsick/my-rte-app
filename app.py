import streamlit as st
import pandas as pd
import plotly.express as px
import easyocr
import numpy as np
from PIL import Image

st.set_page_config(page_title="RTE Auto-Analytic", layout="wide")
st.title("üöÄ RTE Automatic Sales Dashboard")

# 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
TARGET_ITEMS = {
    "203081": "‡∏Æ‡πá‡∏≠‡∏ó‡∏î‡πá‡∏≠‡∏Å", "250561": "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ö‡∏´‡∏°‡∏π ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "274583": "‡∏ä‡∏∏‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î",
    "299207": "‡πÑ‡∏Å‡πà‡∏õ‡πä‡∏≠‡∏õ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "381059": "‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡πÑ‡∏Å‡πà‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Ñ", "395441": "‡∏Æ‡∏∞‡πÄ‡∏Å‡πã‡∏≤‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "614329": "‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏´‡∏°‡∏π‡∏Å‡∏∏‡∏¢‡∏ä‡πà‡∏≤‡∏¢ ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "619903": "‡∏õ‡∏µ‡∏Å‡πÑ‡∏Å‡πà‡∏ö‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å‡∏ã‡∏≠‡∏™",
    "648962": "‡∏Æ‡∏∞‡πÄ‡∏Å‡πã‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô", "779278": "‡πÑ‡∏Å‡πà‡∏õ‡πä‡∏≠‡∏õ", "782617": "‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏´‡∏°‡∏π‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "956994": "‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà"
}

# 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏û (OCR)
@st.cache_resource
def load_reader():
    return easyocr.Reader(['th', 'en'])

reader = load_reader()

uploaded_file = st.file_uploader("üì∑ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà", type=['jpg', 'jpeg', 'png'])

if uploaded_file:
    image = Image.open(uploaded_file)
    st.image(image, caption="‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î", width=300)
    
    with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'):
        img_np = np.array(image)
        result = reader.readtext(img_np)
        
        # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏à‡∏≥‡∏•‡∏≠‡∏á logic ‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á)
        # ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏π‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        parsed_data = []
        full_text = [res[1] for res in result]
        
        # Logic ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô: ‡∏´‡∏≤‡∏Å‡πÄ‡∏à‡∏≠ Art No ‡πÉ‡∏ô‡∏†‡∏≤‡∏û ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        for i, text in enumerate(full_text):
            clean_text = text.replace(" ", "").strip()
            if clean_text in TARGET_ITEMS:
                try:
                    qty = float(full_text[i+2].replace(",", ""))
                    amt = float(full_text[i+3].replace(",", ""))
                    parsed_data.append({
                        "‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": clean_text,
                        "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": TARGET_ITEMS[clean_text],
                        "Qty Sum": qty,
                        "Amount SUM (Vat 7%)": round(amt * 1.07, 2)
                    })
                except: continue

        if parsed_data:
            df = pd.DataFrame(parsed_data)
            
            # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏™‡∏∏‡∏î (Qty)
            df = df.sort_values(by="Qty Sum", ascending=False).reset_index(drop=True)
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Market Share)
            total_sales = df["Amount SUM (Vat 7%)"].sum()
            df["‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á (%)"] = (df["Amount SUM (Vat 7%)"] / total_sales * 100).round(2)

            # --- ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
            st.subheader("üìä ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°")
            
            # ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
            fig = px.line(df, x="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", y="Amount SUM (Vat 7%)", markers=True, title="Trend ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
            st.plotly_chart(fig, use_container_width=True)

            # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞ Mark Top 3
            st.subheader("üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ (Sorted by Qty)")
            
            def highlight_top3(s):
                return ['background-color: #ffd700; color: black; font-weight: bold' if i < 3 else '' for i in range(len(s))]

            st.table(df.style.apply(highlight_top3, axis=0))
            
            st.info(f"üí° ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Top 3 ‡∏ó‡∏≥‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ {df['‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á (%)'].head(3).sum()}% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
        else:
            st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô")
