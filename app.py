import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import easyocr
from PIL import Image

# --- Config & Theme ---
st.set_page_config(page_title="RTE Total Analyst", layout="wide")
st.markdown("""
    <style>
    .main { background-color: #f8f9fa; }
    .stMetric { background-color: white; border: 1px solid #eee; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
""", unsafe_allow_html=True)

# --- ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Master List ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤ + ‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà) ---
MASTER_ITEMS = {
    # ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°
    "203081": "‡∏Æ‡πá‡∏≠‡∏ó‡∏î‡πá‡∏≠‡∏Å", "250561": "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ö‡∏´‡∏°‡∏π ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "274583": "‡∏ä‡∏∏‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î",
    "299207": "‡πÑ‡∏Å‡πà‡∏õ‡πä‡∏≠‡∏õ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "381059": "‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡πÑ‡∏Å‡πà‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Ñ", "395441": "‡∏Æ‡∏∞‡πÄ‡∏Å‡πã‡∏≤‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "614329": "‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏´‡∏°‡∏π‡∏Å‡∏∏‡∏¢‡∏ä‡πà‡∏≤‡∏¢ ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "619903": "‡∏õ‡∏µ‡∏Å‡πÑ‡∏Å‡πà‡∏ö‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å‡∏ã‡∏≠‡∏™",
    "648962": "‡∏Æ‡∏∞‡πÄ‡∏Å‡πã‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô", "779278": "‡πÑ‡∏Å‡πà‡∏õ‡πä‡∏≠‡∏õ", "782617": "‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏´‡∏°‡∏π‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "956994": "‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    # ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠)
    "231259": "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏®", "302490": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á‡πÉ‡∏´‡∏ç‡πà",
    "322224": "‡∏¢‡∏≥‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö", "344174": "‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏±‡∏ô",
    "364882": "‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á", "380450": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà",
    "621822": "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô 99 ‡∏ö‡∏≤‡∏ó", "654830": "‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏™‡πâ",
    "695884": "‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö ‡πÅ‡∏û‡πá‡∏Ñ‡πÉ‡∏´‡∏ç‡πà", "724276": "‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡∏û‡∏∞‡πÇ‡∏•‡πâ (‡πÄ‡∏•‡∏≤‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠)",
    "781110": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ‡πÉ‡∏´‡∏ç‡πà", "951651": "‡∏Å‡∏∏‡πâ‡∏á‡∏ï‡πâ‡∏°",
    "250271": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á", "273023": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Æ‡πà‡∏≠‡∏á‡∏Å‡∏á",
    "967970": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ"
}

DAILY_TARGET = 170000

@st.cache_resource
def get_reader():
    return easyocr.Reader(['th', 'en'])

reader = get_reader()

# --- UI Header ---
st.title("üìä RTE All-in-One Sales Analyst")
uploaded_file = st.file_uploader("üì∑ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢", type=['jpg', 'png', 'jpeg'])

if uploaded_file:
    image = Image.open(uploaded_file)
    img_np = np.array(image)
    
    with st.spinner('AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'):
        result = reader.readtext(img_np)
        full_text_list = [res[1] for res in result]
        
        extracted_rows = []
        for i, text in enumerate(full_text_list):
            code = text.replace(" ", "").strip()
            if code in MASTER_ITEMS:
                try:
                    qty = float(full_text_list[i+2].replace(",", ""))
                    amt = float(full_text_list[i+3].replace(",", ""))
                    extracted_rows.append({"‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": code, "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": MASTER_ITEMS[code], "Qty": qty, "‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT": amt})
                except: continue

        if extracted_rows:
            # 1. ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥ (Groupby)
            df = pd.DataFrame(extracted_rows)
            df = df.groupby(['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']).sum().reset_index()
            
            # 2. Logic ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏¢‡∏≠‡∏î 99 ‡∏ö‡∏≤‡∏ó (621822)
            special_code = "621822"
            if special_code in df['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'].values:
                s_row = df[df['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] == special_code].iloc[0]
                s_qty = s_row['Qty']
                s_amt = s_row['‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT']
                
                # ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô 50/30/20
                dist = {"231259": 0.5, "654830": 0.3, "724276": 0.2}
                for code, ratio in dist.items():
                    if code in df['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'].values:
                        df.loc[df['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] == code, 'Qty'] += (s_qty * ratio)
                        df.loc[df['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] == code, '‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT'] += (s_amt * ratio)
                    else:
                        new_item = {"‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": code, "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": MASTER_ITEMS[code], "Qty": s_qty*ratio, "‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT": s_amt*ratio}
                        df = pd.concat([df, pd.DataFrame([new_item])], ignore_index=True)
                
                # ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 99 ‡∏ö‡∏≤‡∏ó‡∏≠‡∏≠‡∏Å
                df = df[df['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] != special_code]

            # 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (VAT 7%)
            df['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° VAT'] = df['‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT'] * 1.07
            
            # 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
            total_before = df['‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT'].sum()
            total_after = df['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° VAT'].sum()
            achieve_pc = (total_after / DAILY_TARGET) * 100

            # --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢) ---
            
            # Metric Cards
            col1, col2, col3, col4 = st.columns(4)
            col1.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô VAT", f"{total_before:,.2f}")
            col2.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (+7%)", f"{total_after:,.2f}")
            col3.metric("‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô", f"{DAILY_TARGET:,.0f}")
            col4.metric("Achievement", f"{achieve_pc:.2f}%", delta=f"{total_after-DAILY_TARGET:,.2f}")

            st.write("---")
            
            # ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
            st.subheader("üìà Performance Trend (‡∏£‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)")
            fig = px.line(df.sort_values('‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° VAT', ascending=False), 
                          x="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", y="‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° VAT", markers=True,
                          color_discrete_sequence=['#2E5077'])
            fig.update_layout(plot_bgcolor='white')
            st.plotly_chart(fig, use_container_width=True)

            # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            st.subheader("üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢")
            st.dataframe(df.style.format({
                "Qty": "{:.2f}",
                "‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT": "{:,.2f}",
                "‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° VAT": "{:,.2f}"
            }), use_container_width=True)

        else:
            st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û")
