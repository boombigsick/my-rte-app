import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import easyocr
from PIL import Image

# --- Config & Theme (Transparent Indigo Theme) ---
st.set_page_config(page_title="RTE Indigo Analyst", layout="wide")

# CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á‡πÅ‡∏•‡∏∞‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏Ñ‡∏£‡∏≤‡∏°
st.markdown("""
    <style>
    /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ñ‡∏£‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÑ‡∏•‡πà‡πÄ‡∏â‡∏î */
    .stApp {
        background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
        color: white;
    }
    
    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á 50% */
    div[data-testid="stMetric"], .stDataFrame, .stTable, div.stButton > button {
        background-color: rgba(255, 255, 255, 0.15) !important; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á */
        backdrop-filter: blur(10px); /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡∏ù‡πâ‡∏≤ */
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        border-radius: 15px !important;
        color: white !important;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç Metric */
    div[data-testid="stMetricValue"] > div {
        color: #60a5fa !important; /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô‡∏ö‡∏ô‡∏™‡∏µ‡∏Ñ‡∏£‡∏≤‡∏° */
    }
    
    /* ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≤‡∏á‡πÜ */
    h1, h2, h3, p {
        color: #e0e7ff !important;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    .styled-table {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    </style>
""", unsafe_allow_html=True)

# --- Master List (‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤+‡πÉ‡∏´‡∏°‡πà) ---
MASTER_ITEMS = {
    "203081": "‡∏Æ‡πá‡∏≠‡∏ó‡∏î‡πá‡∏≠‡∏Å", "250561": "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ö‡∏´‡∏°‡∏π ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "274583": "‡∏ä‡∏∏‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î",
    "299207": "‡πÑ‡∏Å‡πà‡∏õ‡πä‡∏≠‡∏õ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "381059": "‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡πÑ‡∏Å‡πà‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Ñ", "395441": "‡∏Æ‡∏∞‡πÄ‡∏Å‡πã‡∏≤‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "614329": "‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏´‡∏°‡∏π‡∏Å‡∏∏‡∏¢‡∏ä‡πà‡∏≤‡∏¢ ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "619903": "‡∏õ‡∏µ‡∏Å‡πÑ‡∏Å‡πà‡∏ö‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å‡∏ã‡∏≠‡∏™",
    "648962": "‡∏Æ‡∏∞‡πÄ‡∏Å‡πã‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô", "779278": "‡πÑ‡∏Å‡πà‡∏õ‡πä‡∏≠‡∏õ", "782617": "‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏´‡∏°‡∏π‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "956994": "‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "231259": "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏®", "302490": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á‡πÉ‡∏´‡∏ç‡πà",
    "322224": "‡∏¢‡∏≥‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö", "344174": "‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏±‡∏ô",
    "364882": "‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á", "380450": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà",
    "621822": "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô 99 ‡∏ö‡∏≤‡∏ó", "654830": "‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏™‡πâ",
    "695884": "‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö ‡πÅ‡∏û‡πá‡∏Ñ‡πÉ‡∏´‡∏ç‡πà", "724276": "‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡∏û‡∏∞‡πÇ‡∏•‡πâ (‡πÄ‡∏•‡∏≤‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠)",
    "781110": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ‡πÉ‡∏´‡∏ç‡πà", "951651": "‡∏Å‡∏∏‡πâ‡∏á‡∏ï‡πâ‡∏°",
    "250271": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á", "273023": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Æ‡πà‡∏≠‡∏á‡∏Å‡∏á",
    "967970": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ"
}

DAILY_TARGET = 170000

@st.cache_resource
def get_reader():
    return easyocr.Reader(['th', 'en'])

reader = get_reader()

# --- Main App ---
st.title("üåå RTE Indigo Auto-Analyst")
st.write("‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢")

uploaded_file = st.file_uploader("üì∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢", type=['jpg', 'png', 'jpeg'])

if uploaded_file:
    image = Image.open(uploaded_file)
    img_np = np.array(image)
    
    with st.spinner('üî≠ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏Ñ‡∏£‡∏≤‡∏°...'):
        result = reader.readtext(img_np)
        full_text_list = [res[1] for res in result]
        
        extracted_rows = []
        for i, text in enumerate(full_text_list):
            code = text.replace(" ", "").strip()
            if code in MASTER_ITEMS:
                try:
                    qty = float(full_text_list[i+2].replace(",", ""))
                    amt = float(full_text_list[i+3].replace(",", ""))
                    extracted_rows.append({"‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": code, "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": MASTER_ITEMS[code], "Qty": qty, "‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT": amt})
                except: continue

        if extracted_rows:
            df = pd.DataFrame(extracted_rows).groupby(['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']).sum().reset_index()
            
            # --- Logic ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏¢‡∏≠‡∏î 99 ‡∏ö‡∏≤‡∏ó ---
            if "621822" in df['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'].values:
                s_row = df[df['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] == "621822"].iloc[0]
                dist = {"231259": 0.5, "654830": 0.3, "724276": 0.2}
                for code, ratio in dist.items():
                    if code in df['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'].values:
                        df.loc[df['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] == code, 'Qty'] += (s_row['Qty'] * ratio)
                        df.loc[df['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] == code, '‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT'] += (s_row['‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT'] * ratio)
                    else:
                        new_item = {"‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": code, "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": MASTER_ITEMS[code], "Qty": s_row['Qty']*ratio, "‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT": s_row['‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT']*ratio}
                        df = pd.concat([df, pd.DataFrame([new_item])], ignore_index=True)
                df = df[df['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] != "621822"]

            df['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° VAT'] = df['‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT'] * 1.07
            total_before = df['‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT'].sum()
            total_after = df['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° VAT'].sum()
            achieve_pc = (total_after / DAILY_TARGET) * 100

            # --- Dashboard ---
            col1, col2, col3 = st.columns(3)
            col1.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô VAT", f"{total_before:,.2f} ‡∏ø")
            col2.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (+7%)", f"{total_after:,.2f} ‡∏ø")
            col3.metric("Achievement", f"{achieve_pc:.2f}%", delta=f"{total_after-DAILY_TARGET:,.2f}")

            st.write("---")
            
            # ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô (Line Chart) ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏™‡∏ß‡πà‡∏≤‡∏á
            st.subheader("üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥")
            fig = px.line(df.sort_values('‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° VAT', ascending=False), 
                          x="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", y="‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° VAT", markers=True)
            fig.update_traces(line_color='#60a5fa', marker=dict(size=10, color='white'))
            fig.update_layout(
                paper_bgcolor='rgba(0,0,0,0)', 
                plot_bgcolor='rgba(0,0,0,0)',
                font_color="white"
            )
            st.plotly_chart(fig, use_container_width=True)

            # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            st.subheader("üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
            st.dataframe(df.style.format({
                "Qty": "{:.2f}",
                "‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT": "{:,.2f}",
                "‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° VAT": "{:,.2f}"
            }), use_container_width=True)

        else:
            st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û")
