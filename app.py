import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import easyocr
import numpy as np
from PIL import Image

# --- CONFIG & BRIGHT THEME ---
st.set_page_config(page_title="RTE Executive Report", layout="wide")

# CSS: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß, ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡∏≥, ‡∏Å‡∏•‡πà‡∏≠‡∏á Metric ‡∏Ç‡∏≤‡∏ß‡∏Ç‡∏≠‡∏ö‡πÅ‡∏î‡∏á (‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
st.markdown("""
    <style>
    .main { background-color: #ffffff !important; }
    h1, h2, h3, p, span, label { color: #000000 !important; }
    div[data-testid="stMetric"] { 
        background-color: #ffffff !important; 
        border: 1px solid #dddddd !important; 
        border-top: 5px solid #cc0000 !important; 
        border-radius: 12px !important; 
        padding: 20px !important;
        box-shadow: 2px 2px 15px rgba(0,0,0,0.05);
    }
    div[data-testid="stMetricValue"] > div { color: #cc0000 !important; font-size: 38px !important; font-weight: bold !important; }
    div[data-testid="stMetricLabel"] > label { color: #444444 !important; font-size: 18px !important; }
    section[data-testid="stSidebar"] { background-color: #1a1a1a !important; }
    section[data-testid="stSidebar"] .stMarkdown h2 { color: #ffffff !important; }
    .stTable { background-color: white !important; color: black !important; }
    </style>
    """, unsafe_allow_html=True)

TARGET_REVENUE = 170000.0

# --- MASTER DATA ---
CATEGORY_MAP = {
    "203081": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "250561": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "274583": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "299207": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô",
    "381059": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "395441": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "614329": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "619903": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô",
    "648962": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "779278": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "782617": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "956994": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô",
    "231259": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "302490": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "322224": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "344174": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô",
    "364882": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "380450": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "621822": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "654830": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô",
    "695884": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "724276": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "781110": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "951651": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô",
    "250271": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "273023": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "967970": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô"
}

PRODUCT_NAMES = {
    "203081": "‡∏Æ‡πá‡∏≠‡∏ó‡∏î‡πá‡∏≠‡∏Å", "250561": "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ö‡∏´‡∏°‡∏π ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "274583": "‡∏ä‡∏∏‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î",
    "299207": "‡πÑ‡∏Å‡πà‡∏õ‡πä‡∏≠‡∏õ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "381059": "‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡πÑ‡∏Å‡πà‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Ñ", "395441": "‡∏Æ‡∏∞‡πÄ‡∏Å‡πã‡∏≤‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "614329": "‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏´‡∏°‡∏π‡∏Å‡∏∏‡∏¢‡∏ä‡πà‡∏≤‡∏¢ ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "619903": "‡∏õ‡∏µ‡∏Å‡πÑ‡∏Å‡πà‡∏ö‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å‡∏ã‡∏≠‡∏™",
    "648962": "‡∏Æ‡∏∞‡πÄ‡∏Å‡πã‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô", "779278": "‡πÑ‡∏Å‡πà‡∏õ‡πä‡∏≠‡∏õ", "782617": "‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏´‡∏°‡∏π‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "956994": "‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "231259": "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏®", 
    "302490": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á‡πÉ‡∏´‡∏ç‡πà", "322224": "‡∏¢‡∏≥‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö", "344174": "‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏±‡∏ô", 
    "364882": "‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á", "380450": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà", "621822": "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô 99 ‡∏ö‡∏≤‡∏ó", 
    "654830": "‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏™‡πâ", "695884": "‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö ‡πÅ‡∏û‡πá‡∏Ñ‡πÉ‡∏´‡∏ç‡πà", 
    "724276": "‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡∏û‡∏∞‡πÇ‡∏•‡πâ (‡πÄ‡∏•‡∏≤‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠)", "781110": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ‡πÉ‡∏´‡∏ç‡πà", 
    "951651": "‡∏Å‡∏∏‡πâ‡∏á‡∏ï‡πâ‡∏°", "250271": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á", 
    "273023": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Æ‡πà‡∏≠‡∏á‡∏Å‡∏á", "967970": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ"
}

@st.cache_resource
def get_reader():
    return easyocr.Reader(['th', 'en'])

reader = get_reader()

# --- SIDEBAR ---
with st.sidebar:
    st.markdown("## ‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠")
    page = st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤", ["üè† ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°", "üçü ‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "üç± ‡∏´‡∏°‡∏ß‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô"])
    uploaded_file = st.file_uploader("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢", type=['jpg', 'png', 'jpeg'])

if uploaded_file:
    image = Image.open(uploaded_file)
    img_np = np.array(image)
    
    with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'):
        result = reader.readtext(img_np)
        full_text = [res[1] for res in result]
        
        extracted = {}
        for i, text in enumerate(full_text):
            code = text.replace(" ", "").strip()
            if code in CATEGORY_MAP:
                try:
                    # ‡∏õ‡∏£‡∏±‡∏ö Index ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏ä‡πà‡∏≠‡∏á Qty ‡πÅ‡∏•‡∏∞ Net Amount
                    qty = float(full_text[i+2].replace(",", ""))
                    amt = float(full_text[i+3].replace(",", ""))
                    extracted[code] = {"q": qty, "a": amt}
                except: continue

        # --- CONDITION ZONE ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô (621822) ---
        if "621822" in extracted:
            v99 = extracted.pop("621822")
            # ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏¢‡∏≠‡∏î: 50% ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î, 30% ‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ, 20% ‡∏Ç‡∏≤‡∏´‡∏°‡∏π
            for c, r in {"231259": 0.5, "654830": 0.3, "724276": 0.2}.items():
                if c not in extracted: extracted[c] = {"q": 0, "a": 0}
                extracted[c]["q"] += v99["q"] * r
                extracted[c]["a"] += v99["a"] * r

        df = pd.DataFrame([
            {"‡∏´‡∏°‡∏ß‡∏î": CATEGORY_MAP[c], "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": PRODUCT_NAMES[c], "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": v["q"], 
             "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°": v["a"], "‡∏£‡∏≤‡∏Ñ‡∏≤+VAT": round(v["a"] * 1.07, 2)}
            for c, v in extracted.items()
        ])

    if not df.empty:
        if page == "üè† ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°":
            st.title("üçé ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏£‡∏∏‡∏õ (Station Overview)")
            
            total_vat = df["‡∏£‡∏≤‡∏Ñ‡∏≤+VAT"].sum()
            achieve = (total_vat / TARGET_REVENUE) * 100
            
            # Gauge & Stats
            c1, c2 = st.columns([2, 1])
            with c1:
                fig = go.Figure(go.Indicator(
                    mode="gauge+number", value=total_vat,
                    title={'text': "Achievement vs Target (170k)"},
                    gauge={'axis': {'range': [None, TARGET_REVENUE]},
                           'bar': {'color': "#cc0000"},
                           'bgcolor': "white",
                           'steps': [{'range': [0, TARGET_REVENUE], 'color': "#f5f5f5"}]}))
                st.plotly_chart(fig, use_container_width=True)
            
            with c2:
                st.metric("Achievement %", f"{achieve:.2f}%")
                st.metric("‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (+VAT)", f"{total_vat:,.2f}")
                st.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏° (‡∏Å‡πà‡∏≠‡∏ô VAT)", f"{df['‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°'].sum():,.2f}")

            st.markdown("---")
            
            # --- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏™‡πÄ‡∏ï‡∏ä‡∏±‡πà‡∏ô (Station Total) ---
            st.subheader("üè¢ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ (Station Summary)")
            station_sum = df.groupby("‡∏´‡∏°‡∏ß‡∏î")[["‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°", "‡∏£‡∏≤‡∏Ñ‡∏≤+VAT"]].sum().reset_index()
            st.table(station_sum.style.format({"‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°": "{:,.2f}", "‡∏£‡∏≤‡∏Ñ‡∏≤+VAT": "{:,.2f}"}))

            # --- 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≥ ---
            st.subheader("‚ö†Ô∏è 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏•‡∏±‡∏Å‡∏î‡∏±‡∏ô (Low Qty)")
            low_3 = df.sort_values("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô").head(3)
            lcols = st.columns(3)
            for i, row in enumerate(low_3.itertuples()):
                lcols[i].metric(row.‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, f"{row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô} ‡∏ä‡∏¥‡πâ‡∏ô", f"‡∏¢‡∏≠‡∏î: {row._5:,.2f} ‡∏ö‡∏≤‡∏ó")

        else:
            # ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î
            cat_name = "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô" if "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô" in page else "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô"
            st.title(f"üìç ‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å‡∏´‡∏°‡∏ß‡∏î: {cat_name}")
            sub_df = df[df["‡∏´‡∏°‡∏ß‡∏î"] == cat_name].sort_values("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", ascending=False)
            
            m1, m2 = st.columns(2)
            m1.metric(f"‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° {cat_name} (‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°)", f"{sub_df['‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°'].sum():,.2f}")
            m2.metric(f"‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° {cat_name} (+VAT)", f"{sub_df['‡∏£‡∏≤‡∏Ñ‡∏≤+VAT'].sum():,.2f}")
            
            st.table(sub_df.style.format({"‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°": "{:,.2f}", "‡∏£‡∏≤‡∏Ñ‡∏≤+VAT": "{:,.2f}"}))
else:
    st.info("üëà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢")
