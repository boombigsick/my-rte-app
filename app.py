import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import easyocr
import numpy as np
from PIL import Image

# --- CONFIG & LIGHT THEME ---
st.set_page_config(page_title="RTE Sales Report", layout="wide")

# ‡∏õ‡∏£‡∏±‡∏ö CSS ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢: ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡∏≥ ‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß ‡πÄ‡∏ô‡πâ‡∏ô‡πÅ‡∏î‡∏á
st.markdown("""
    <style>
    .main { background-color: #ffffff; }
    div[data-testid="stMetric"] { 
        background-color: #f9f9f9; 
        border: 1px solid #dddddd; 
        border-radius: 8px; 
        padding: 15px; 
    }
    div[data-testid="stMetricValue"] { color: #cc0000 !important; font-size: 32px !important; }
    div[data-testid="stMetricLabel"] { color: #333333 !important; font-size: 16px !important; }
    .stTable { border: 1px solid #eeeeee; }
    h1, h2, h3 { color: #000000; }
    </style>
    """, unsafe_allow_html=True)

TARGET_REVENUE = 170000.0

# --- MASTER DATA ---
CATEGORY_MAP = {
    "203081": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "250561": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "274583": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "299207": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô",
    "381059": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "395441": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "614329": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "619903": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô",
    "648962": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "779278": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "782617": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "956994": "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô",
    "231259": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "302490": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "322224": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "344174": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô",
    "364882": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "380450": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "621822": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "654830": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô",
    "695884": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "724276": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "781110": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "951651": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô",
    "250271": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "273023": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô", "967970": "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô"
}

PRODUCT_NAMES = {
    "203081": "‡∏Æ‡πá‡∏≠‡∏ó‡∏î‡πá‡∏≠‡∏Å", "250561": "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ö‡∏´‡∏°‡∏π ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "274583": "‡∏ä‡∏∏‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î",
    "299207": "‡πÑ‡∏Å‡πà‡∏õ‡πä‡∏≠‡∏õ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "381059": "‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡πÑ‡∏Å‡πà‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Ñ", "395441": "‡∏Æ‡∏∞‡πÄ‡∏Å‡πã‡∏≤‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "614329": "‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏´‡∏°‡∏π‡∏Å‡∏∏‡∏¢‡∏ä‡πà‡∏≤‡∏¢ ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "619903": "‡∏õ‡∏µ‡∏Å‡πÑ‡∏Å‡πà‡∏ö‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å‡∏ã‡∏≠‡∏™",
    "648962": "‡∏Æ‡∏∞‡πÄ‡∏Å‡πã‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô", "779278": "‡πÑ‡∏Å‡πà‡∏õ‡πä‡∏≠‡∏õ", "782617": "‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏´‡∏°‡∏π‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà",
    "956994": "‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ï‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà", "231259": "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏®", 
    "302490": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á‡πÉ‡∏´‡∏ç‡πà", "322224": "‡∏¢‡∏≥‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö", "344174": "‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏±‡∏ô", 
    "364882": "‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á", "380450": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà", "621822": "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô 99 ‡∏ö‡∏≤‡∏ó", 
    "654830": "‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏™‡πâ", "695884": "‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö ‡πÅ‡∏û‡πá‡∏Ñ‡πÉ‡∏´‡∏ç‡πà", 
    "724276": "‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡∏û‡∏∞‡πÇ‡∏•‡πâ (‡πÄ‡∏•‡∏≤‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠)", "781110": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ‡πÉ‡∏´‡∏ç‡πà", 
    "951651": "‡∏Å‡∏∏‡πâ‡∏á‡∏ï‡πâ‡∏°", "250271": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏î‡∏¢‡πà‡∏≤‡∏á", 
    "273023": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡∏´‡∏°‡∏π‡πÅ‡∏î‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Æ‡πà‡∏≠‡∏á‡∏Å‡∏á", "967970": "‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î‡∏û‡∏∞‡πÇ‡∏•‡πâ"
}

@st.cache_resource
def get_reader():
    return easyocr.Reader(['th', 'en'])

reader = get_reader()

# --- SIDEBAR ---
with st.sidebar:
    st.markdown("## ‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤")
    page = st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤", ["üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°", "üçü ‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "üç± ‡∏´‡∏°‡∏ß‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô"])
    uploaded_file = st.file_uploader("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢", type=['jpg', 'png', 'jpeg'])

if uploaded_file:
    image = Image.open(uploaded_file)
    img_np = np.array(image)
    
    with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'):
        result = reader.readtext(img_np)
        full_text = [res[1] for res in result]
        
        extracted = {}
        for i, text in enumerate(full_text):
            code = text.replace(" ", "").strip()
            if code in CATEGORY_MAP:
                try:
                    # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Index: ‡∏Ç‡∏¢‡∏±‡∏ö‡πÑ‡∏õ 2 ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Qty, 3 ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Amount
                    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏£‡∏¥‡∏á
                    q_val = full_text[i+2].replace(",", "")
                    a_val = full_text[i+3].replace(",", "")
                    extracted[code] = {"q": float(q_val), "a": float(a_val)}
                except: continue

        # ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏¢‡∏≠‡∏î 99 ‡∏ö‡∏≤‡∏ó (621822)
        if "621822" in extracted:
            p99 = extracted.pop("621822")
            for c, r in {"231259": 0.5, "654830": 0.3, "724276": 0.2}.items():
                if c not in extracted: extracted[c] = {"q": 0, "a": 0}
                extracted[c]["q"] += p99["q"] * r
                extracted[c]["a"] += p99["a"] * r

        # ‡∏™‡∏£‡πâ‡∏≤‡∏á DataFrame
        df = pd.DataFrame([
            {"Category": CATEGORY_MAP[c], "Name": PRODUCT_NAMES[c], "Qty": v["q"], 
             "Amt_Net": v["a"], "Amt_Vat": round(v["a"] * 1.07, 2)}
            for c, v in extracted.items()
        ])

    if not df.empty:
        if page == "üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°":
            st.title("üçé ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Overview)")
            
            # --- Gauge ---
            total_vat = df["Amt_Vat"].sum()
            achieve = (total_vat / TARGET_REVENUE) * 100
            
            c1, c2 = st.columns([2, 1])
            with c1:
                fig = go.Figure(go.Indicator(
                    mode="gauge+number", value=total_vat,
                    title={'text': "Achievement vs Target (170k)"},
                    gauge={'axis': {'range': [None, TARGET_REVENUE]},
                           'bar': {'color': "#cc0000"},
                           'steps': [{'range': [0, TARGET_REVENUE], 'color': "#f2f2f2"}]}))
                st.plotly_chart(fig, use_container_width=True)
            
            with c2:
                st.metric("Achievement", f"{achieve:.2f}%")
                st.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (+VAT)", f"{total_vat:,.2f}")
                st.metric("‡∏Ç‡∏≤‡∏î‡∏≠‡∏µ‡∏Å", f"{max(0, TARGET_REVENUE - total_vat):,.2f}")

            # --- ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏™‡πÄ‡∏ï‡∏ä‡∏±‡πà‡∏ô ---
            st.subheader("üè¢ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ (Station Total)")
            station_total = df.groupby("Category")[["Amt_Net", "Amt_Vat"]].sum().reset_index()
            st.table(station_total.style.format({"Amt_Net": "{:,.2f}", "Amt_Vat": "{:,.2f}"}))

            # --- 3 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ï‡∏Å ---
            st.subheader("‚ö†Ô∏è 3 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏î‡∏±‡∏ô‡∏¢‡∏≠‡∏î (Low Qty)")
            low_3 = df.sort_values("Qty").head(3)
            cols = st.columns(3)
            for i, row in enumerate(low_3.itertuples()):
                cols[i].warning(f"**{row.Name}**\nQty: {row.Qty} | ‡∏¢‡∏≠‡∏î: {row.Amt_Vat:,.2f}")

        else:
            cat_name = "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô" if "Snack" in page else "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô"
            st.title(f"üìç ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏ß‡∏î: {cat_name}")
            sub_df = df[df["Category"] == cat_name].sort_values("Qty", ascending=False)
            
            # ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤
            m1, m2 = st.columns(2)
            m1.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô VAT", f"{sub_df['Amt_Net'].sum():,.2f}")
            m2.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (+VAT)", f"{sub_df['Amt_Vat'].sum():,.2f}")
            
            st.table(sub_df.style.format({"Amt_Net": "{:,.2f}", "Amt_Vat": "{:,.2f}"}))
else:
    st.info("üëà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢")
